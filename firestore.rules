rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función para verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'admin';
    }
    
    // Función para verificar si el usuario es profesor
    function isProfesor() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'profesor';
    }
    
    // Función para verificar si el usuario es estudiante
    function isEstudiante() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'estudiante';
    }
    
    // Reglas para usuarios
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Permitir crear su propio perfil durante registro O si es admin
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow update: if isAdmin() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }
    
    // Reglas para cursos
    match /cursos/{cursoId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Reglas para secciones
    match /secciones/{seccionId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isProfesor();
      allow update: if isAdmin() || isProfesor();
      allow delete: if isAdmin();
    }
    
    // Reglas para lecciones
    match /lecciones/{leccionId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isProfesor();
      allow update: if isAdmin() || isProfesor();
      allow delete: if isAdmin();
    }
    
    // Reglas para lecciones como subcolección (legacy)
    match /cursos/{cursoId}/lecciones/{leccionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isProfesor();
    }
    
    // Reglas para tareas
    match /tareas/{tareaId} {
      allow read: if isAuthenticated();
      allow create: if isProfesor() || isAdmin();
      allow update: if isProfesor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Reglas para entregas de tareas
    match /entregas/{entregaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Permitir actualización al estudiante dueño, profesores y admins
      allow update: if isAuthenticated() && 
                     (resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      allow delete: if isAdmin();
    }
    
    // Reglas para calificaciones
    match /calificaciones/{calificacionId} {
      // TEMPORALMENTE MÁS PERMISIVO PARA DEBUG
      allow read, list: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ==================== NUEVAS REGLAS PARA EXÁMENES ====================
    
    // Reglas para exámenes
    match /examenes/{examenId} {
      // Cualquier usuario autenticado puede leer exámenes
      allow read: if isAuthenticated();
      
      // Solo profesores y admins pueden crear, actualizar y eliminar exámenes
      allow create: if isProfesor() || isAdmin();
      allow update: if isProfesor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Reglas para intentos de exámenes
    match /intentos/{intentoId} {
      // Leer documento individual: El estudiante dueño del intento, profesores y admins
      allow get: if isAuthenticated() && 
                   (resource.data.estudianteId == request.auth.uid || 
                    isProfesor() || 
                    isAdmin());
      
      // Permitir queries (list) para cualquier usuario autenticado
      // Las queries filtrarán por estudianteId en el código
      allow list: if isAuthenticated();
      
      // Crear: Cualquier estudiante autenticado puede crear un intento
      allow create: if isAuthenticated() && 
                     request.resource.data.estudianteId == request.auth.uid;
      
      // Actualizar: El estudiante dueño (para guardar respuestas), profesores y admins
      allow update: if isAuthenticated() && 
                     (resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }

    // Intentos de exámenes (nueva colección con nombre diferente)
    match /intentosExamenes/{intentoId} {
      // Leer: El estudiante dueño del intento, profesores y admins
      allow read: if isAuthenticated() && 
                   (resource.data.estudianteId == request.auth.uid || 
                    isProfesor() || 
                    isAdmin());
      
      // Crear: Cualquier estudiante autenticado puede crear un intento
      allow create: if isAuthenticated() && 
                     request.resource.data.estudianteId == request.auth.uid;
      
      // Actualizar: El estudiante dueño (para guardar respuestas), profesores y admins
      allow update: if isAuthenticated() && 
                     (resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // ==================== REGLAS PARA SISTEMA DE CALIFICACIONES ====================
    
    // Reglas para configuración de calificaciones
    match /configuracionCalificaciones/{configId} {
      // Leer: Cualquier usuario autenticado puede leer y listar
      allow get, list: if isAuthenticated();
      
      // Crear/Actualizar: Solo profesores y admins
      allow create: if isProfesor() || isAdmin();
      allow update: if isProfesor() || isAdmin();
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // Reglas para calificaciones de estudiantes (calculadas)
    match /calificacionesEstudiantes/{calificacionId} {
      // Leer: El estudiante dueño, profesores y admins
      allow read: if isAuthenticated() && 
                   (resource.data.estudianteId == request.auth.uid || 
                    isProfesor() || 
                    isAdmin());
      
      // Crear/Actualizar: Solo profesores y admins (cálculos automáticos)
      allow create: if isProfesor() || isAdmin();
      allow update: if isProfesor() || isAdmin();
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // Reglas para progreso de estudiantes
    match /progresoEstudiantes/{progresoId} {
      // Leer: El estudiante dueño, profesores y admins
      allow read: if isAuthenticated() && 
                   (resource.data.estudianteId == request.auth.uid || 
                    isProfesor() || 
                    isAdmin());
      
      // Crear/Actualizar: El estudiante dueño (al completar actividades), profesores y admins
      allow create: if isAuthenticated() && 
                     (request.resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      allow update: if isAuthenticated() && 
                     (resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // Reglas para progreso de lecciones individuales
    match /progresoLecciones/{progresoLeccionId} {
      // Leer documento individual: Validar por ID del documento
      // Formato del ID: {estudianteId}_{leccionId}
      allow get: if isAuthenticated() && 
                   (progresoLeccionId.matches('^' + request.auth.uid + '_.*') || 
                    isProfesor() || 
                    isAdmin());
      
      // Listar (queries con where): Permitir a todos autenticados
      // Las queries filtrarán por estudianteId en el código
      allow list: if isAuthenticated();
      
      // Crear/Actualizar: El estudiante dueño (al completar lecciones), profesores y admins
      allow create: if isAuthenticated() && 
                     (request.resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      allow update: if isAuthenticated() && 
                     (resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // ==================== REGLAS PARA DESBLOQUEO PROGRESIVO ====================
    
    // Reglas para progreso con sistema de caché
    match /progreso/{progresoId} {
      // El ID tiene formato: {estudianteId}_{seccionId}
      // Extraer el estudianteId del ID del documento (parte antes del primer _)
      
      // Leer: El estudiante propietario, profesores y admins
      allow read: if isAuthenticated() && 
                   (progresoId.matches('^' + request.auth.uid + '_.*') || 
                    isProfesor() || 
                    isAdmin());
      
      // Crear: Cualquier usuario autenticado (se crea automáticamente al calcular progreso)
      allow create: if isAuthenticated() && 
                     (request.resource.data.estudianteId == request.auth.uid || 
                      isProfesor() || 
                      isAdmin());
      
      // Actualizar: El estudiante propietario (al completar actividades), profesores y admins
      allow update: if isAuthenticated() && 
                     (progresoId.matches('^' + request.auth.uid + '_.*') || 
                      isProfesor() || 
                      isAdmin());
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // ====================================================================
    // REGLAS PARA ASISTENCIAS
    // ====================================================================
    match /asistencias/{asistenciaId} {
      // Leer: Todos los autenticados pueden leer asistencias
      allow read: if isAuthenticated();
      
      // Crear/Actualizar: Solo profesores del curso o admins
      // El profesor debe ser el profesor del curso al que pertenece la asistencia
      allow create, update: if isProfesor() || isAdmin();
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // ====================================================================
    // REGLAS PARA SOLICITUDES DE INSCRIPCIÓN
    // ====================================================================
    match /solicitudes-inscripcion/{solicitudId} {
      // Leer: El estudiante dueño de la solicitud, profesores y admins
      allow get: if isAuthenticated() && 
                   (resource.data.estudianteId == request.auth.uid || 
                    isProfesor() || 
                    isAdmin());
      
      // Listar (queries): Estudiantes pueden listar sus propias solicitudes, admins todas
      allow list: if isAuthenticated();
      
      // Crear: Solo estudiantes autenticados, y deben crear con su propio ID
      allow create: if isAuthenticated() && 
                     request.resource.data.estudianteId == request.auth.uid &&
                     request.resource.data.estado == 'pendiente';
      
      // Actualizar: Solo admins (para aceptar/rechazar solicitudes)
      allow update: if isAdmin();
      
      // Eliminar: Solo admins
      allow delete: if isAdmin();
    }
    
    // ====================================================================
    // REGLAS PARA CONFIGURACIÓN DEL HOME (CMS)
    // ====================================================================
    match /configuracion-home/{configId} {
      // Leer: Cualquier usuario (incluso no autenticado) puede leer la configuración del home
      // Esto es necesario para que los visitantes vean la página sin login
      allow read: if true;
      
      // Crear/Actualizar: Solo admins pueden modificar la configuración
      allow create, update: if isAdmin();
      
      // Eliminar: Solo admins (aunque en la práctica no se debería eliminar)
      allow delete: if isAdmin();
    }
    
    // ====================================================================
  }
}
