<div class="course-viewer-container">
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light me-2" (click)="goBack()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <!-- Botón hamburguesa para móviles -->
        <button class="btn btn-outline-light me-2 d-md-none" (click)="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      <span class="navbar-brand mb-0 h1 flex-grow-1 text-center text-md-start" *ngIf="curso">
        <i class="fas fa-book d-none d-md-inline"></i> {{ curso.titulo }}
      </span>
      <button class="btn btn-outline-light" (click)="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </nav>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando curso...</p>
  </div>

  <!-- Main Content -->
  <div class="main-container" *ngIf="!loading && curso">
    <!-- Overlay para cerrar menú en móviles -->
    <div class="sidebar-overlay"
         *ngIf="sidebarOpen"
         (click)="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" [class.open]="sidebarOpen">
      <div class="sidebar-header">
        <h5><i class="fas fa-list"></i> Contenido del Curso</h5>
      </div>

      <div class="sections-list">
        <div class="section-item" *ngFor="let seccion of secciones; let i = index">
          <!-- Sección Header -->
          <div class="section-header" (click)="toggleSeccion(seccion)">
            <div class="section-info">
              <i class="fas" [class.fa-chevron-right]="!seccion.expanded" [class.fa-chevron-down]="seccion.expanded"></i>
              <span class="section-number">{{ i + 1 }}.</span>
              <span class="section-title">{{ seccion.titulo }}</span>
            </div>
            <span class="badge bg-secondary">{{ seccion.lecciones.length }}</span>
          </div>

          <!-- Lecciones de la Sección -->
          <div class="section-content" *ngIf="seccion.expanded">
            <!-- Lección -->
            <div class="leccion-item" *ngFor="let leccion of seccion.lecciones">
              <!-- Header de Lección -->
              <div class="leccion-header"
                   [class.active]="contenidoActual.tipo === 'leccion' && contenidoActual.elemento?.id === leccion.id">
                <div class="leccion-info" (click)="loadLeccion(seccion, leccion)">
                  <i class="fas fa-book-open"></i>
                  <span class="leccion-titulo">{{ leccion.titulo }}</span>
                </div>
                <div class="leccion-actions">
                  <span class="badge bg-primary"
                        *ngIf="leccion.tareasData.length > 0"
                        (click)="toggleLeccion(leccion); $event.stopPropagation()"
                        style="cursor: pointer;"
                        title="Click para ver/ocultar tareas">
                    {{ leccion.tareasData.length }} tarea{{ leccion.tareasData.length !== 1 ? 's' : '' }}
                  </span>
                  <i class="fas ms-2"
                     *ngIf="leccion.tareasData.length > 0"
                     [class.fa-chevron-down]="!leccion.expanded"
                     [class.fa-chevron-up]="leccion.expanded"
                     (click)="toggleLeccion(leccion); $event.stopPropagation()"
                     style="cursor: pointer;"
                     title="Click para ver/ocultar tareas"></i>
                </div>
              </div>

              <!-- Tareas de la Lección -->
              <div class="tareas-list" *ngIf="leccion.expanded && leccion.tareasData.length > 0">
                <div class="tarea-item"
                     *ngFor="let tarea of leccion.tareasData"
                     [class.active]="contenidoActual.tipo === 'tarea' && contenidoActual.elemento?.id === tarea.id"
                     (click)="loadTarea(seccion, tarea); $event.stopPropagation()">
                  <i class="fas fa-tasks"></i>
                  <span class="tarea-titulo">{{ tarea.titulo }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="text-center py-4 text-muted" *ngIf="secciones.length === 0">
          <i class="fas fa-inbox fa-3x mb-3"></i>
          <p>Este curso no tiene contenido aún</p>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- No content selected -->
      <div class="no-content" *ngIf="!contenidoActual.elemento">
        <i class="fas fa-hand-pointer fa-4x mb-4 text-muted"></i>
        <h4 class="text-muted">Selecciona un elemento del menú</h4>
        <p class="text-muted">Haz clic en una lección o tarea para ver su contenido</p>
      </div>

      <!-- Leccion Content -->
      <div class="content-wrapper" *ngIf="getLeccionActual() as leccion">
        <div class="content-header">
          <span class="badge bg-info mb-2">
            <i class="fas fa-book-open"></i> Lección
          </span>
          <h2>{{ leccion.titulo }}</h2>
          <p class="text-muted" *ngIf="contenidoActual.seccionTitulo">
            <i class="fas fa-folder"></i> {{ contenidoActual.seccionTitulo }}
          </p>
        </div>

        <div class="content-body">
          <!-- Contenido según tipo -->
          <div class="lesson-content mt-4">
            <!-- Texto -->
            <div *ngIf="leccion.tipo === 'texto'" class="texto-content">
              <div class="card">
                <div class="card-body">
                  <div [innerHTML]="leccion.contenido" style="white-space: pre-wrap;"></div>
                </div>
              </div>
            </div>

            <!-- Video YouTube -->
            <div *ngIf="leccion.tipo === 'video' && leccion.urlYoutube" class="video-content">
              <h5><i class="fas fa-video"></i> Video de la Lección</h5>
              <div class="video-container">
                <iframe
                  [src]="getYoutubeEmbedUrl(leccion.urlYoutube)"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
                </iframe>
              </div>
            </div>

            <!-- PDF -->
            <div *ngIf="leccion.tipo === 'pdf' && leccion.urlArchivo" class="pdf-content">
              <h5><i class="fas fa-file-pdf"></i> Documento PDF</h5>
              <div class="pdf-container">
                <iframe [src]="getSafePdfUrl(leccion.urlArchivo)" frameborder="0"></iframe>
              </div>
              <a [href]="leccion.urlArchivo" target="_blank" class="btn btn-outline-primary mt-2">
                <i class="fas fa-external-link-alt"></i> Abrir en nueva pestaña
              </a>
            </div>

            <!-- Imagen -->
            <div *ngIf="leccion.tipo === 'imagen' && leccion.urlArchivo" class="imagen-content">
              <h5><i class="fas fa-image"></i> Imagen</h5>
              <img [src]="leccion.urlArchivo" [alt]="leccion.titulo" class="img-fluid rounded">
            </div>
          </div>
        </div>
      </div>

      <!-- Tarea Content -->
      <div class="content-wrapper" *ngIf="getTareaActual() as tarea">
        <div class="content-header">
          <span class="badge bg-warning mb-2">
            <i class="fas fa-tasks"></i> Tarea
          </span>
          <h2>{{ tarea.titulo }}</h2>
          <p class="text-muted" *ngIf="contenidoActual.seccionTitulo">
            <i class="fas fa-folder"></i> {{ contenidoActual.seccionTitulo }}
          </p>
        </div>

        <div class="content-body">
          <!-- Descripción -->
          <div class="description-section" *ngIf="tarea.descripcion">
            <h5><i class="fas fa-info-circle"></i> Descripción</h5>
            <p>{{ tarea.descripcion }}</p>
          </div>

          <!-- Instrucciones -->
          <div class="instructions-section mt-3" *ngIf="tarea.instrucciones">
            <h5><i class="fas fa-list-ol"></i> Instrucciones</h5>
            <div class="card bg-light">
              <div class="card-body">
                <p style="white-space: pre-wrap;">{{ tarea.instrucciones }}</p>
              </div>
            </div>
          </div>

          <!-- Detalles de la Tarea -->
          <div class="task-details mt-4">
            <div class="row">
              <div class="col-md-6">
                <div class="detail-item">
                  <strong><i class="fas fa-calendar-alt"></i> Fecha inicio:</strong>
                  <span>{{ tarea.fechaInicio | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                <div class="detail-item">
                  <strong><i class="fas fa-calendar-check"></i> Fecha límite:</strong>
                  <span [class.text-danger]="isTaskOverdue(tarea)">
                    {{ tarea.fechaFin | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="detail-item">
                  <strong><i class="fas fa-percentage"></i> Ponderación:</strong>
                  <span class="badge bg-info">{{ tarea.ponderacion }}%</span>
                </div>
                <div class="detail-item">
                  <strong><i class="fas fa-file-upload"></i> Tipo de entrega:</strong>
                  <span class="badge bg-secondary">
                    {{ tarea.tipoEntrega === 'texto' ? 'Solo Texto' : tarea.tipoEntrega === 'archivo' ? 'Solo Archivo' : 'Texto y Archivo' }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Entrega del Estudiante -->
          <div class="mt-4" *ngIf="userRole === 'estudiante'">
            <h5 class="mb-3"><i class="fas fa-paper-plane"></i> Tu Entrega</h5>

            <div class="card border-success mb-3" *ngIf="contenidoActual.entrega && contenidoActual.entrega.estado === 'calificada'">
              <div class="card-header bg-success text-white">
                <i class="fas fa-check-circle"></i> Tarea Calificada
              </div>
              <div class="card-body">
                <h4 class="text-success">Calificación: {{ contenidoActual.entrega.calificacion }}/100</h4>
                <p *ngIf="contenidoActual.entrega.retroalimentacion">
                  <strong>Retroalimentación:</strong><br>
                  {{ contenidoActual.entrega.retroalimentacion }}
                </p>
              </div>
            </div>

            <div class="card border-info mb-3" *ngIf="contenidoActual.entrega && contenidoActual.entrega.estado !== 'calificada'">
              <div class="card-header bg-info text-white">
                <i class="fas fa-info-circle"></i> Ya entregaste esta tarea
              </div>
              <div class="card-body">
                <p>Entregado el: {{ contenidoActual.entrega.fechaEntrega | date:'dd/MM/yyyy HH:mm' }}</p>
                <p>Estado: <span class="badge bg-info">{{ contenidoActual.entrega.estado }}</span></p>
              </div>
            </div>

            <div class="alert alert-warning" *ngIf="!contenidoActual.entrega">
              <i class="fas fa-exclamation-triangle"></i> Aún no has entregado esta tarea
            </div>

            <button class="btn btn-primary btn-lg w-100" (click)="entregarTarea(getTareaActual()!.id)">
              <i class="fas fa-paper-plane"></i> {{ contenidoActual.entrega ? 'Modificar Entrega' : 'Entregar Tarea' }}
            </button>
          </div>

          <!-- Debug info (temporal) -->
          <div class="mt-3 p-2 bg-light border" *ngIf="!userRole || userRole === ''">
            <small class="text-danger">Debug: userRole no está definido. UserRole actual: "{{ userRole }}"</small>
          </div>

          <!-- Opciones del Profesor -->
          <div class="mt-4" *ngIf="userRole === 'profesor' && getTareaActual()">
            <button class="btn btn-success me-2" (click)="verEntregas(getTareaActual()!.id)">
              <i class="fas fa-eye"></i> Ver Entregas
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
