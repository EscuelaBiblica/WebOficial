<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="fas fa-home me-2"></i>Configuración del Home
          </h2>
          <p class="text-muted mb-0">
            <i class="fas fa-cog me-1"></i>
            FASE 1 - Hero y Sección Cursos
          </p>
        </div>
        <div>
          <button class="btn btn-outline-secondary me-2" (click)="volverAdmin()">
            <i class="fas fa-arrow-left me-1"></i>Volver
          </button>
          <button class="btn btn-info" (click)="verVistaPrevia()">
            <i class="fas fa-eye me-1"></i>Vista Previa
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs de Navegación -->
  <div class="row mb-4" *ngIf="!loading">
    <div class="col-12">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link"
             [class.active]="tabActiva === 'hero'"
             (click)="cambiarTab('hero')"
             style="cursor: pointer;">
            <i class="fas fa-image me-2"></i>Hero/Masthead
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link"
             [class.active]="tabActiva === 'cursos'"
             (click)="cambiarTab('cursos')"
             style="cursor: pointer;">
            <i class="fas fa-graduation-cap me-2"></i>Sección Cursos
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Mensajes -->
  <div class="row mb-3" *ngIf="mensaje">
    <div class="col-12">
      <div class="alert alert-dismissible fade show"
           [class.alert-success]="mensaje.tipo === 'success'"
           [class.alert-danger]="mensaje.tipo === 'error'"
           [class.alert-info]="mensaje.tipo === 'info'"
           role="alert">
        <i class="fas fa-check-circle me-2" *ngIf="mensaje.tipo === 'success'"></i>
        <i class="fas fa-exclamation-circle me-2" *ngIf="mensaje.tipo === 'error'"></i>
        <i class="fas fa-info-circle me-2" *ngIf="mensaje.tipo === 'info'"></i>
        {{ mensaje.texto }}
        <button type="button" class="btn-close" (click)="mensaje = null"></button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="row" *ngIf="loading">
    <div class="col-12">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando configuración...</p>
      </div>
    </div>
  </div>

  <!-- Formulario Hero -->
  <div class="row" *ngIf="!loading && tabActiva === 'hero'">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>Editar Hero/Masthead
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="heroForm" (ngSubmit)="guardarCambios()">

            <!-- Subtítulo 1 -->
            <div class="mb-4">
              <label for="subtitulo1" class="form-label fw-bold">
                <i class="fas fa-heading me-2"></i>Subtítulo 1
              </label>
              <input
                type="text"
                class="form-control"
                id="subtitulo1"
                formControlName="subtitulo1"
                placeholder="¡Desarrolla tu fe!"
                [class.is-invalid]="heroForm.get('subtitulo1')?.invalid && heroForm.get('subtitulo1')?.touched">
              <div class="form-text">
                Primer texto que aparece en el banner principal
              </div>
              <div class="invalid-feedback">
                Este campo es requerido
              </div>
            </div>

            <!-- Subtítulo 2 (Horario) -->
            <div class="mb-4">
              <label for="subtitulo2" class="form-label fw-bold">
                <i class="fas fa-clock me-2"></i>Subtítulo 2 (Horario)
              </label>
              <input
                type="text"
                class="form-control"
                id="subtitulo2"
                formControlName="subtitulo2"
                placeholder="CLASES TODOS LOS DOMINGOS A LAS 18:00PM"
                [class.is-invalid]="heroForm.get('subtitulo2')?.invalid && heroForm.get('subtitulo2')?.touched">
              <div class="form-text">
                Información del horario de clases
              </div>
              <div class="invalid-feedback">
                Este campo es requerido
              </div>
            </div>

            <!-- Título Principal -->
            <div class="mb-4">
              <label for="titulo" class="form-label fw-bold">
                <i class="fas fa-font me-2"></i>Título Principal
              </label>
              <input
                type="text"
                class="form-control form-control-lg"
                id="titulo"
                formControlName="titulo"
                placeholder="ESCUELA BÍBLICA CAVEVID"
                [class.is-invalid]="heroForm.get('titulo')?.invalid && heroForm.get('titulo')?.touched">
              <div class="form-text">
                Título grande en mayúsculas
              </div>
              <div class="invalid-feedback">
                Este campo es requerido
              </div>
            </div>

            <!-- Texto del Botón -->
            <div class="mb-4">
              <label for="botonTexto" class="form-label fw-bold">
                <i class="fas fa-mouse-pointer me-2"></i>Texto del Botón
              </label>
              <input
                type="text"
                class="form-control"
                id="botonTexto"
                formControlName="botonTexto"
                placeholder="Ver cursos"
                [class.is-invalid]="heroForm.get('botonTexto')?.invalid && heroForm.get('botonTexto')?.touched">
              <div class="form-text">
                Texto que aparece en el botón del hero
              </div>
              <div class="invalid-feedback">
                Este campo es requerido
              </div>
            </div>

            <!-- Link del Botón -->
            <div class="mb-4">
              <label for="botonLink" class="form-label fw-bold">
                <i class="fas fa-link me-2"></i>Link del Botón
              </label>
              <input
                type="text"
                class="form-control"
                id="botonLink"
                formControlName="botonLink"
                placeholder="#services"
                [class.is-invalid]="heroForm.get('botonLink')?.invalid && heroForm.get('botonLink')?.touched">
              <div class="form-text">
                Hacia dónde lleva el botón (use # para anclas internas)
              </div>
              <div class="invalid-feedback">
                Este campo es requerido
              </div>
            </div>

            <!-- Imagen de Fondo (Cloudinary) -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                <i class="fas fa-image me-2"></i>Imagen de Fondo (Opcional)
              </label>

              <div class="card border" *ngIf="config?.hero?.imagenFondo">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-md-3">
                      <img [src]="config?.hero?.imagenFondo || ''" class="img-fluid rounded" alt="Imagen de fondo actual">
                    </div>
                    <div class="col-md-6">
                      <p class="mb-1 small text-muted">Imagen actual:</p>
                      <p class="mb-0 small">{{ config?.hero?.imagenFondo }}</p>
                    </div>
                    <div class="col-md-3 text-end">
                      <button type="button" class="btn btn-sm btn-danger" (click)="eliminarImagenFondo()">
                        <i class="fas fa-trash me-1"></i>Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="input-group mt-2">
                <input
                  type="file"
                  class="form-control"
                  id="imagenFondo"
                  accept="image/*"
                  (change)="onImagenFondoSelected($event)"
                  [disabled]="uploadingImage">
                <label class="input-group-text" for="imagenFondo">
                  <i class="fas fa-upload me-1"></i>
                  {{ uploadingImage ? 'Subiendo...' : 'Seleccionar' }}
                </label>
              </div>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Imagen de fondo para el Hero. Recomendado: 1920x1080px, máx 5MB.
                Si no se especifica, se usa la imagen por defecto del CSS.
              </div>
            </div>

            <!-- Información de Última Actualización -->
            <div class="alert alert-light border" *ngIf="config">
              <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                Última actualización: {{ config.ultimaActualizacion | date:'medium' }}
                por {{ config.actualizadoPor }}
              </small>
            </div>

            <!-- Botones de Acción -->
            <div class="d-flex justify-content-between">
              <button
                type="button"
                class="btn btn-outline-warning"
                (click)="resetearValores()"
                [disabled]="saving">
                <i class="fas fa-undo me-1"></i>Restablecer Valores
              </button>

              <div>
                <button
                  type="submit"
                  class="btn btn-primary btn-lg"
                  [disabled]="heroForm.invalid || saving">
                  <span *ngIf="!saving">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                  </span>
                  <span *ngIf="saving">
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Guardando...
                  </span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Información Técnica Hero -->
      <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Información Técnica
          </h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Los cambios se aplican <strong>inmediatamente</strong> en el home</li>
            <li>El caché se invalida automáticamente al guardar</li>
            <li>Los visitantes verán los cambios en su próxima carga</li>
            <li>Esta es la <strong>FASE 1</strong> - Hero y Sección Cursos</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario Cursos -->
  <div class="row" *ngIf="!loading && tabActiva === 'cursos'">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-graduation-cap me-2"></i>Editar Sección Cursos
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="cursosForm" (ngSubmit)="guardarCambiosCursos()">

            <!-- Toggle de visibilidad -->
            <div class="form-check form-switch mb-4">
              <input class="form-check-input" type="checkbox" id="cursosVisible"
                     formControlName="visible">
              <label class="form-check-label fw-bold" for="cursosVisible">
                <i class="fas fa-eye me-2"></i>Sección Visible en el Home
              </label>
            </div>

            <hr>
            <div class="row mb-4">
              <div class="col-md-6">
                <label for="cursosTitulo" class="form-label fw-bold">
                  <i class="fas fa-heading me-2"></i>Título de la Sección
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="cursosTitulo"
                  formControlName="titulo"
                  placeholder="Cursos">
              </div>
              <div class="col-md-6">
                <label for="cursosSubtitulo" class="form-label fw-bold">
                  <i class="fas fa-text-height me-2"></i>Subtítulo
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="cursosSubtitulo"
                  formControlName="subtitulo"
                  placeholder="Dos niveles para elegir.">
              </div>
            </div>

            <hr>

            <!-- Lista de Cursos -->
            <div formArrayName="cursos">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-list me-2"></i>Cursos</h5>
                <button type="button" class="btn btn-sm btn-success" (click)="agregarCurso()">
                  <i class="fas fa-plus me-1"></i>Agregar Curso
                </button>
              </div>

              <div *ngFor="let curso of cursos.controls; let i = index" class="card mb-3">
                <div class="card-header bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Curso {{ i + 1 }}</h6>
                    <button type="button" class="btn btn-sm btn-danger" (click)="eliminarCurso(i)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body" [formGroupName]="i">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Título</label>
                      <input type="text" class="form-control" formControlName="titulo" placeholder="Básico">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Subtítulo</label>
                      <input type="text" class="form-control" formControlName="subtitulo" placeholder="Estudio Bíblico Fundamental">
                    </div>
                    <div class="col-md-12 mb-3">
                      <label class="form-label fw-bold">
                        Icono
                        <span class="badge bg-primary ms-2">
                          <i class="fas" [ngClass]="curso.value.icono || 'fa-question'"></i>
                          {{ curso.value.icono ? 'Seleccionado' : 'Ninguno' }}
                        </span>
                      </label>
                      <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        <div class="row g-2">
                          <div class="col-auto" *ngFor="let icono of iconosDisponibles">
                            <button
                              type="button"
                              class="btn btn-sm"
                              [class.btn-primary]="curso.value.icono === icono.clase"
                              [class.btn-outline-secondary]="curso.value.icono !== icono.clase"
                              (click)="curso.get('icono')?.setValue(icono.clase)"
                              [title]="icono.nombre"
                              style="width: 45px; height: 45px;"
                            >
                              <i class="fas fa-lg" [ngClass]="icono.clase"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <small class="text-muted">Haz clic en un icono para seleccionarlo</small>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label fw-bold">Descripción</label>
                    <textarea class="form-control" formControlName="descripcion" rows="2"
                              placeholder="Descripción del curso..."></textarea>
                  </div>

                  <!-- Materias del curso -->
                  <div formArrayName="materias">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="form-label fw-bold mb-0">Materias</label>
                      <button type="button" class="btn btn-sm btn-outline-primary" (click)="agregarMateria(i)">
                        <i class="fas fa-plus me-1"></i>Agregar Materia
                      </button>
                    </div>

                    <div *ngFor="let materia of getMaterias(i).controls; let j = index"
                         class="input-group mb-2" [formGroupName]="j">
                      <input type="text" class="form-control" formControlName="nombre" placeholder="Nombre de la materia">
                      <select class="form-select" formControlName="estado" style="max-width: 150px;">
                        <option [ngValue]="null">Sin badge</option>
                        <option value="en-curso">EN CURSO</option>
                        <option value="proximamente">PRÓXIMAMENTE</option>
                        <option value="completado">COMPLETADO</option>
                      </select>
                      <button type="button" class="btn btn-outline-danger" (click)="eliminarMateria(i, j)">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Información de Última Actualización -->
            <div class="alert alert-light border" *ngIf="config">
              <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                Última actualización: {{ config.ultimaActualizacion | date:'medium' }}
                por {{ config.actualizadoPor }}
              </small>
            </div>

            <!-- Botones de Acción -->
            <div class="d-flex justify-content-between">
              <button
                type="button"
                class="btn btn-outline-warning"
                (click)="resetearValores()"
                [disabled]="saving">
                <i class="fas fa-undo me-1"></i>Restablecer Todo
              </button>

              <div>
                <button
                  type="submit"
                  class="btn btn-success btn-lg"
                  [disabled]="cursosForm.invalid || saving">
                  <span *ngIf="!saving">
                    <i class="fas fa-save me-2"></i>Guardar Cursos
                  </span>
                  <span *ngIf="saving">
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Guardando...
                  </span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Información Técnica Cursos -->
      <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Tips
          </h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Puedes agregar o eliminar cursos dinámicamente</li>
            <li>Cada curso puede tener múltiples materias</li>
            <li>Los estados de materia muestran badges: EN CURSO, PRÓXIMAMENTE, COMPLETADO</li>
            <li>Los íconos son de Font Awesome (versión 6)</li>
            <li>Puedes ocultar toda la sección con el switch "Sección Visible"</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
